name: Auto-invite to org

on:
  issues:
    types: [opened]

permissions:
  issues: write

jobs:
  invite:
    if: contains(github.event.issue.labels.*.name, 'org-invite')
    runs-on: ubuntu-latest
    steps:
      - name: Extract username from issue body
        id: parse
        run: |
          USERNAME=$(python3 - <<'PY'
            import re, os
            body = os.environ["BODY"]
            # GitHub form renders as **Label** or ### Label then value on next line(s)
            m = re.search(r'\*\*GitHub username\*\*\s*\n\s*([A-Za-z0-9_-]+)', body) or \
                re.search(r'GitHub username\s*\n\s*([A-Za-z0-9_-]+)', body)
            print(m.group(1).strip() if m else "")
          PY
          )
          echo "username=$USERNAME" >> $GITHUB_OUTPUT
        env:
          BODY: ${{ github.event.issue.body }}

      - name: Invite user to GitHub org
        if: steps.parse.outputs.username != ''
        run: |
          curl -sS -X PUT \
            -H "Authorization: Bearer $ORG_ADMIN_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/orgs/$ORG/memberships/${{ steps.parse.outputs.username }}" \
            -d '{"role":"member"}'
        env:
          ORG: AIFrontiersLab
          ORG_ADMIN_TOKEN: ${{ secrets.ORG_ADMIN_TOKEN }}

      - name: Comment back
        run: |
          gh issue comment "$ISSUE" --repo "$GITHUB_REPOSITORY" --body "âœ… Thanks! If your username was valid, an org invite has been sent. Please check GitHub notifications and accept it."
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE: ${{ github.event.issue.number }}
          GITHUB_REPOSITORY: ${{ github.repository }}
